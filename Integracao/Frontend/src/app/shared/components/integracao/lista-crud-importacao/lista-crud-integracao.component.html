<div class="app-container">
  <!-- #region Cabeçalho da tela -->
  <div
    class="header"
    style="display: flex; justify-content: space-between; align-items: center"
  >
    <button class="tour-button" (click)="onHelp()" type="button">
      <i class="fas fa-question-circle"></i> Ajuda
    </button>
    <h2 class="title" style="margin: 0 auto">{{ title }}</h2>
    <div style="display: flex; gap: 0.5rem; align-items: center">
      <button class="new-integration-btn" (click)="onAdd()" type="button">
        <i class="fas fa-plus"></i> Novo
      </button>
      <button
        class="new-integration-btn"
        type="button"
        (click)="onExportSelectedToExcel()"
        [disabled]="internalSelectedItems.length === 0"
        title="Exporte apenas os registros selecionados"
        *ngIf="showExportSelectedButton"
      >
        <i class="fas fa-file-excel"></i> Exportar Excel Selecionados
      </button>
      <button
        class="new-integration-btn"
        type="button"
        (click)="onAddProductsToSelected()"
        title="Adicionar produtos à lista selecionada"
        *ngIf="showAddProductsButton"
      >
        >
        <i class="fas fa-boxes"></i> Adicionar produtos
      </button>
      <button
        class="new-integration-btn"
        type="button"
        *ngIf="internalSelectedItems.length === 1"
        (click)="onViewDoc(internalSelectedItems[0])"
        title="Abrir documentação relacionada"
      >
        <i class="fas fa-book-open"></i> Ver Documentação
      </button>
    </div>
  </div>
  <!-- #endregion -->

  <!-- #region KPIs de resumo -->
  <div class="dashboard-kpi-container summary-kpis" *ngIf="summary?.length">
    <div
      class="dashboard-kpi-card"
      *ngFor="let item of summary"
      (click)="filterBySummary(item.value, item.key)"
    >
      <h2>{{ item.key }}</h2>
      <h2>
        {{
          isDate(item.value) ? (item.value | date : "dd/MM/yyyy") : item.value
        }}
      </h2>
      <p>{{ item.count }}</p>
    </div>
  </div>
  <!-- #endregion -->

  <!-- #region Tabela completa -->
  <div class="table-wrapper">
    <div class="crud-table">

      <!-- #region Cabeçalho da Tabela -->
      <div class="crud-table-header">
        <div class="crud-col col-select align-center"
          *ngIf="showExportSelectedButton"
        >
          <input
            type="checkbox"
            [checked]="allSelected"
            (change)="toggleSelectAll()"
          />
        </div>
        <ng-container *ngFor="let field of fields">
          <ng-container *ngIf="isFieldVisible(field.name)">
            <div
              class="crud-col"
              [ngClass]="[field.columnClass, getAlignClass(field.align)]"
            >
              {{ field.label.trim() || formatLabel(field.name) }}
            </div>
          </ng-container>
          <ng-container *ngIf="isComplexField(field.name)">
            <ng-container *ngFor="let sub of visibleSubColumnsOf(field.name)">
              <div class="crud-col">
                {{
                  (field.label || formatLabel(field.name)) +
                    " • " +
                    formatLabel(sub)
                }}
              </div>
            </ng-container>
          </ng-container>
        </ng-container>
        <div class="crud-col actions-col">
          Ações
          <button
            class="action-btn config-btn"
            (click)="openGridConfig()"
            type="button"
            title="Configurar colunas"
          >
            <i class="fas fa-cog"></i>
          </button>
          <div
            class="resizer"
            (mousedown)="startResize($event, 'actions-col')"
          ></div>
        </div>
      </div>
      <!-- #endregion -->

      <!-- #region Filtros da Tabela -->
      <div class="crud-table-header filters-row">
        <div class="crud-col col-select" *ngIf="showExportSelectedButton"></div>
        <ng-container *ngFor="let field of fields">
          <div
            class="crud-col"
            [ngClass]="field.columnClass"
            *ngIf="isFieldVisible(field.name)"
          >
            <input
              [type]="isDateField(field.name) ? 'date' : 'text'"
              [(ngModel)]="columnFilters[field.name]"
              [placeholder]="
                isDateField(field.name) ? 'Selecionar...' : 'Filtrar...'
              "
              class="column-filter-input"
            />
          </div>
          <ng-container *ngIf="isComplexField(field.name)">
            <ng-container *ngFor="let sub of visibleSubColumnsOf(field.name)">
              <div class="crud-col">
                <input
                  type="text"
                  [(ngModel)]="columnFilters[field.name + '.' + sub]"
                  placeholder="Filtrar..."
                  class="column-filter-input"
                />
              </div>
            </ng-container>
          </ng-container>
        </ng-container>
        <div class="crud-col actions-col">
          <button class="btn-secondary" (click)="clearFilters()">Limpar</button>
        </div>
      </div>
      <!-- #endregion -->

      <!-- #region Corpo da Tabela (dados) -->
      <div class="table-body">
        <div class="crud-table-row" *ngFor="let item of filteredItems">
          <div class="crud-col col-select align-center"
          *ngIf="showExportSelectedButton"
          >
            <input
              type="checkbox"
              [checked]="isItemSelected(item)"
              (change)="toggleSelection(item)"
            />
          </div>
          <ng-container *ngFor="let field of fields">
            <ng-container *ngIf="isFieldVisible(field.name)">
              <div
                class="crud-col"
                [ngClass]="[field.columnClass, getAlignClass(field.align)]"
              >
                {{
                  isDateField(field.name) && isDate(item[field.name])
                    ? (item[field.name] | date : "dd/MM/yyyy")
                    : item[field.name]
                }}
              </div>
            </ng-container>
            <ng-container *ngIf="isComplexField(field.name)">
              <ng-container *ngFor="let sub of visibleSubColumnsOf(field.name)">
                <div class="crud-col">
                  {{ getValueByPath(item, field.name + "." + sub) }}
                </div>
              </ng-container>
            </ng-container>
          </ng-container>
          <div class="crud-col actions-col">
            <button
              class="action-btn delete-btn"
              (click)="onAskDelete(item)"
              title="Excluir"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
            <button
              class="action-btn config-btn"
              (click)="openDetailsModal(item)"
              title="Detalhes"
            >
              <i class="fas fa-eye"></i>
            </button>
            <button
              class="action-btn excel-btn"
              (click)="viewExcel.emit(item)"
              title="Ver Excel"
            >
              <i class="fas fa-file-excel"></i>
            </button>
          </div>
        </div>
      </div>
      <!-- #endregion -->

      <!-- #region Modal de Exclusão Simples -->
      <div *ngIf="isDeleteModalOpen" class="app-modal-overlay">
        <div class="app-modal-container">
          <div class="modal-header">
            <i class="fas fa-exclamation-triangle warning-icon"></i>
            <h3 class="modal-title">Excluir Registro</h3>
          </div>
          <p>
            Tem certeza que deseja excluir o item
            <strong>{{ itemToDelete?.nome }}</strong
            >?
          </p>
          <div class="app-modal-buttons">
            <button class="btn-danger" (click)="onConfirmDelete()">
              Sim, excluir
            </button>
            <button class="btn-secondary" (click)="closeDeleteModal()">
              Cancelar
            </button>
          </div>
        </div>
      </div>
      <!-- #endregion -->

      <!-- #region Modal de Justificativa de Exclusão -->
      <div *ngIf="isJustificationModalOpen" class="app-modal-overlay">
        <div class="app-modal-container">
          <div class="modal-header">
            <i class="fas fa-exclamation-triangle warning-icon"></i>
            <h3 class="modal-title">Justificativa para Exclusão</h3>
          </div>
          <div class="modal-body">
            <p>
              Você está prestes a excluir o item
              <strong>{{
                itemToDeleteWithJustification?.nome ||
                  itemToDeleteWithJustification?.nomeArquivo
              }}</strong
              >. Por favor, informe o motivo:
            </p>
            <textarea
              [(ngModel)]="justificationText"
              [placeholder]="justificationPlaceholder"
              rows="4"
              class="form-control"
              style="width: 100%; resize: none; margin-top: 10px"
            ></textarea>
            <div
              *ngIf="
                justificationText.length > 0 &&
                justificationText.length < justificationMinLength
              "
              class="error-message"
              style="
                color: rgb(135, 106, 106);
                margin-top: 5px;
                font-size: 12px;
              "
            >
              Justificativa deve ter pelo menos
              {{ justificationMinLength }} caracteres.
            </div>
            <div style="color: #666; margin-top: 5px; font-size: 12px">
              {{ justificationText.length }}/{{ justificationMinLength }}
              caracteres mínimos
            </div>
          </div>
          <div class="app-modal-buttons">
            <button class="btn-secondary" (click)="closeJustificationModal()">
              Cancelar
            </button>
            <button
              class="btn-danger"
              (click)="confirmDeleteWithJustification()"
              [disabled]="!isJustificationValid()"
            >
              <i class="fas fa-trash-alt"></i>
              Confirmar Exclusão
            </button>
          </div>
        </div>
      </div>
      <!-- #endregion -->

      <!-- #region Modal de Colunas Visíveis (Configuração de Grid) -->
      <div *ngIf="isConfigModalOpen" class="app-modal-overlay">
        <div class="app-modal-container">
          <div class="modal-header">
            <i class="fas fa-sliders-h text-blue"></i>
            <h3 class="modal-title">Configurar Colunas Visíveis</h3>
          </div>
          <p>Selecione os campos que você deseja exibir:</p>
          <div class="select-all-row-centralizado">
            <input
              type="checkbox"
              [checked]="allFieldsVisible()"
              (change)="toggleAllFields()"
              id="checkAllFields"
            />
            <label for="checkAllFields" class="label-select-all">
              <strong>Selecionar Todos</strong>
            </label>
          </div>
          <div class="field-visibility-list">
            <ng-container *ngFor="let field of fields">
              <div
                *ngIf="!isComplexField(field.name)"
                class="field-visibility-item"
              >
                <input
                  type="checkbox"
                  [checked]="isFieldVisible(field.name)"
                  (change)="toggleFieldVisibility(field.name)"
                  id="{{ 'col-' + field.name }}"
                />
                <label [for]="'col-' + field.name">
                  {{ field.label.trim() || formatLabel(field.name) }}
                </label>
              </div>
              <div
                *ngIf="isComplexField(field.name)"
                class="field-visibility-item item-with-expand"
              >
                <div class="inline">
                  <button
                    class="btn-expand"
                    (click)="toggleExpandComplexField(field.name)"
                    type="button"
                    [attr.aria-expanded]="isComplexExpanded(field.name)"
                    [title]="
                      isComplexExpanded(field.name) ? 'Recolher' : 'Expandir'
                    "
                  >
                    <i
                      class="fas"
                      [ngClass]="{
                        'fa-angle-down': isComplexExpanded(field.name),
                        'fa-angle-right': !isComplexExpanded(field.name)
                      }"
                    ></i>
                  </button>
                  <input
                    type="checkbox"
                    [checked]="isFieldVisible(field.name)"
                    (change)="toggleFieldVisibility(field.name)"
                    id="{{ 'col-' + field.name }}"
                  />
                  <label [for]="'col-' + field.name">
                    {{ field.label.trim() || formatLabel(field.name) }}
                  </label>
                </div>
                <div class="subfields" *ngIf="isComplexExpanded(field.name)">
                  <div
                    class="subfield-item"
                    *ngFor="let sub of getSubKeysOf(field.name)"
                  >
                    <input
                      type="checkbox"
                      [checked]="isFieldVisible(field.name + '.' + sub)"
                      (change)="toggleFieldVisibility(field.name + '.' + sub)"
                      id="{{ 'col-' + field.name + '.' + sub }}"
                    />
                    <label [for]="'col-' + field.name + '.' + sub">
                      {{ formatLabel(sub) }}
                    </label>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
          <div class="app-modal-buttons">
            <button class="btn-secondary" (click)="closeGridConfig()">
              Fechar
            </button>
          </div>
        </div>
      </div>
      <!-- #endregion -->

      <!-- #region Modal de Detalhes -->
      <div *ngIf="isDetailsModalOpen" class="app-modal-overlay">
        <div class="app-modal-container modal-md details-modal-modern">
          <div class="modal-header">
            <i class="fas fa-eye"></i>
            <h3 class="modal-title">Detalhes do Registro</h3>
          </div>
          <div *ngIf="itemToView" class="details-fields-list-modern">
            <ng-container *ngFor="let field of fields">

              <div
                *ngIf="!isComplexField(field.name)"
                class="field-details-card"
              >
                <div class="field-details-label">
                  {{ field.label || formatLabel(field.name) }}:
                </div>
                <div class="field-details-value">
                  {{ itemToView[field.name] ?? "(sem valor)" }}
                </div>
              </div>

              <div
                *ngIf="isComplexField(field.name)"
                class="field-details-card card-expandable"
              >
                <div
                  class="field-details-expand-head"
                  (click)="toggleDetailsExpand(field.name)"
                >
                  <button
                    class="details-expand-btn-modern"
                    type="button"
                    [attr.aria-expanded]="isDetailsExpanded(field.name)"
                    [title]="
                      isDetailsExpanded(field.name) ? 'Recolher' : 'Expandir'
                    "
                  >
                    <i
                      class="fas"
                      [ngClass]="{
                        'fa-angle-down': isDetailsExpanded(field.name),
                        'fa-angle-right': !isDetailsExpanded(field.name)
                      }"
                    ></i>
                  </button>
                  <span class="field-details-label field-details-group">
                    {{ field.label || formatLabel(field.name) }}
                    <span class="field-details-count"
                      >({{ getSubKeysOf(field.name).length }} itens)</span
                    >
                  </span>
                </div>
                <div
                  *ngIf="isDetailsExpanded(field.name)"
                  class="details-subfields-list-modern"
                >
                  <div
                    class="details-subfield-item-modern"
                    *ngFor="let sub of getSubKeysOf(field.name)"
                  >
                    <span class="details-key-modern">{{ sub }}:</span>
                    <span class="details-val-modern">{{
                      getValueByPath(itemToView, field.name + "." + sub) ??
                        "(sem valor)"
                    }}</span>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
          <div *ngIf="!itemToView" class="no-details-message">
            <i class="fas fa-eye-slash text-red"></i>
            <p>Nenhum detalhe para exibir.</p>
          </div>
          <div class="app-modal-buttons">
            <button class="btn-secondary" (click)="closeDetailsModal()">
              Fechar
            </button>
          </div>
        </div>
      </div>
      <!-- #endregion -->
    </div>
  </div>
  <!-- #endregion -->
</div>